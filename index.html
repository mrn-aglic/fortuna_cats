<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cats</title>

    <link rel="stylesheet" href="stylesheets/css/styles.css">
    <link rel="stylesheet" href="stylesheets/css/carousel.css">

    <script type="module" src="/repositories/cats_repository.js"></script>
    <script type="module" src="/classes/cat.js"></script>
    <script type="module" src="/classes/catcontainer.js"></script>

    <script type="module">

        // import {Cat} from './classes/cat.js';
        import {Cats} from './classes/catcontainer.js';
        import getCats from './repositories/cats_repository.js';

        function asSlide(slide) {
            // slide.classList.add('d-none');
            slide.classList.remove('slide-preview');
            slide.classList.add('slide');
        }

        function preview(slide) {
            slide.classList.add('slide-preview');
            show(slide);
        }

        function removePreview(slide) {
            slide.classList.remove('slide-preview');
            slide.classList.remove('slide-preview-left');
            slide.classList.remove('slide-preview-right');
        }

        function leftPreview(slide) {
            slide.classList.add('slide-preview-left');
        }

        function rightPreview(slide) {
            slide.classList.add('slide-preview-right');
        }

        function asSlidePreview(slide) {
            slide.classList.add('slide-preview');
        }

        function hide(slide) {
            slide.classList.add('d-none');
        }

        function show(slide) {
            slide.classList.remove('d-none');
        }

        function setActive(slide) {
            slide.classList.add('active');
            removePreview(slide);
            show(slide);
        }

        function removeActiveState(slide) {
            slide.classList.remove('active');
        }

        function isActive(slide) {
            return slide.classList.contains('active');
        }

        function createImgFromCat(cat) {
            const img = document.createElement('img');
            img.src = cat.url;
            return img;
        }

        function createSlide(cat) {

            const img = createImgFromCat(cat);

            const container = document.createElement('div');
            const textNode = document.createElement('div');
            textNode.innerText = cat.name;

            asSlide(container);
            hide(container);

            textNode.classList.add('slide-text');

            container.appendChild(img);
            container.appendChild(textNode);

            return container;
        }

        function populateCarousel(carousel, slides) {
            const firstBtn = carousel.querySelector('div.btn');
            const insert = carousel.childNodes.length === 0 ? carousel.appendChild : slide => carousel.insertBefore(slide, firstBtn);
            slides.forEach(insert);
        }

        function getLeftAndRight(idx, slides) {
            const leftIdx = getLeftIndex(idx, slides);
            const rightIdx = getRightIndex(idx, slides);

            return [slides[leftIdx], slides[rightIdx]];
        }

        function initSlides(carousel, slides, currIdx = 0) {

            const [left, right] = getLeftAndRight(currIdx, slides);
            display(slides[currIdx], left, right);

            leftPreview(left);
            rightPreview(right);
            carousel.insertBefore(left, slides[currIdx]);
        }

        function display(current, prev, to_display) {
            setActive(current);
            preview(prev);
            preview(to_display);
        }

        function hidePreview(preview) {
            removePreview(preview);
            hide(preview);
        }

        function getCurrentIndex(slides) {
            return slides.findIndex(s => isActive(s));
        }

        function getCurrentSlide(slides) {
            return slides.find(s => isActive(s));
        }

        function getRightIndex(idx, slides) {
            return idx >= slides.length - 1 ? 0 : idx + 1;
        }

        function getLeftIndex(idx, slides) {
            return idx <= 0 ? slides.length - 1 : idx - 1;
        }

        function getElements(getIdxToHide, getIdxToPreview) {

            const carousel = document.getElementById('carousel');
            const slides = [...carousel.querySelectorAll('.slide')];

            const idx = getCurrentIndex(slides);

            const prev = slides[idx];

            const to_hide = slides[getIdxToHide(idx, slides)];

            const newIdx = getIdxToPreview(idx, slides);
            const curr = slides[newIdx];
            const to_display = slides[getIdxToPreview(newIdx, slides)];

            return [carousel, curr, prev, to_display, to_hide]
        }

        function moveRight() {
            const [carousel, curr, prev, to_display, to_hide] = getElements(getLeftIndex, getRightIndex);

            removeActiveState(prev);
            hidePreview(to_hide);

            rightPreview(to_display);
            leftPreview(prev);

            carousel.appendChild(to_hide);
            display(curr, prev, to_display);
        }

        function moveLeft() {
            const [carousel, curr, prev, to_display, to_hide] = getElements(getRightIndex, getLeftIndex);
            const before = curr;

            removeActiveState(prev);
            hidePreview(to_hide);

            leftPreview(to_display);
            rightPreview(prev);

            carousel.insertBefore(to_hide, before);
            display(curr, prev, to_display);
        }

        window.moveRight = moveRight;
        window.moveLeft = moveLeft;
        window.onload = async function () {

            const catsArr = await getCats();
            const cats = new Cats(catsArr);

            const carouselCats = cats.getYoungest(3);
            const carousel = document.getElementById('carousel');

            const slides = carouselCats.map(c => createSlide(c));
            console.log(slides)
            populateCarousel(carousel, slides);
            initSlides(carousel, slides, 0);

            const debug = true;
            const intervalTime = 2000;

            setInterval(function () {

                if (debug) return;

                const active = document.querySelector('.active:hover');
                const isActiveHovered = active !== null;

                if (!isActiveHovered) {
                    moveRight()
                }
            }, intervalTime);
        }
    </script>
</head>
<body>
<div id="carousel-container">
    <div id="carousel">
        <!--        <div class="btn btn-prev" onclick="moveLeft()">-->
        <!--            <span class="arrow">&#10094;</span>-->
        <!--        </div>-->
        <!--        <div class="btn btn-next" onclick="moveRight()">-->
        <!--            <span class="arrow">&#10095;</span>-->
        <!--        </div>-->
    </div>
    <div class="btn btn-prev" onclick="moveLeft()">
        <span class="arrow">&#10094;</span>
    </div>
    <div class="btn btn-next" onclick="moveRight()">
        <span class="arrow">&#10095;</span>
    </div>
</div>
<div class="testing">
    <img src="https://static.toiimg.com/photo/72975551.cms"/>
</div>
</body>
</html>