<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cats</title>

    <link rel="stylesheet" href="stylesheets/css/styles.css">
    <link rel="stylesheet" href="stylesheets/css/carousel.css">
    <link rel="stylesheet" href="stylesheets/css/cards.css">

    <script type="module" src="/repositories/cats_repository.js"></script>
    <script type="module" src="/classes/cat.js"></script>
    <script type="module" src="/classes/catcontainer.js"></script>
    <script type="module" src="/classes/cardscontainer.js"></script>

    <script type="module">

        import {Cats} from './classes/catcontainer.js';
        import {CardsContainer} from './classes/cardscontainer.js';
        import getCats from './repositories/cats_repository.js';

        function asSlide(slide) {
            slide.classList.remove('slide-preview');
            slide.classList.add('slide');
        }

        function preview(slide) {
            slide.classList.add('slide-preview');
            show(slide);
        }

        function previewBoth(left, right) {
            preview(left);
            preview(right);
            leftPreview(left);
            rightPreview(right);
        }

        function removePreview(slide) {
            slide.classList.remove('slide-preview');
            slide.classList.remove('slide-preview-left');
            slide.classList.remove('slide-preview-right');
        }

        function leftPreview(slide) {
            slide.classList.add('slide-preview-left');
            preview(slide);
        }

        function rightPreview(slide) {
            slide.classList.add('slide-preview-right');
            preview(slide);
        }

        function hide(slide) {
            slide.classList.add('d-none');
        }

        function show(slide) {
            slide.classList.remove('d-none');
        }

        function setActive(slide) {
            slide.classList.add('active');
            removePreview(slide);
            show(slide);
        }

        function removeActiveState(slide) {
            slide.classList.remove('active');
        }

        function isActive(slide) {
            return slide.classList.contains('active');
        }

        function isSlide(el) {
            return el.matches('.slide');
        }

        function createImgFromCat(cat) {
            const img = document.createElement('img');
            img.src = cat.url;
            return img;
        }

        function createSlide(cat) {

            const img = createImgFromCat(cat);

            const container = document.createElement('div');
            const textNode = document.createElement('div');
            textNode.innerText = cat.name;

            asSlide(container);
            hide(container);

            textNode.classList.add('slide-text');

            container.appendChild(img);
            container.appendChild(textNode);

            return container;
        }

        function populateCarousel(carousel, slides) {
            const firstBtn = carousel.querySelector('div.btn');
            const insert = carousel.childNodes.length === 0 ? carousel.appendChild : slide => carousel.insertBefore(slide, firstBtn);
            slides.forEach(insert);
        }

        function getLeftAndRight(idx, slides) {
            return [getPrev(slides[idx]), getNext(slides[idx])];
        }

        function initSlides(carousel, slides, currIdx = 0) {

            const [left, right] = getLeftAndRight(currIdx, slides);
            display(slides[currIdx], left, right);

            carousel.insertBefore(left, slides[currIdx]);
        }

        function display(current, left, right) {
            setActive(current);
            previewBoth(left, right);
        }

        function hidePreview(preview) {
            removePreview(preview);
            hide(preview);
        }

        function getNext(active) {
            const next = active.nextElementSibling;
            return next === null || !isSlide(next) ? active.parentNode.firstElementChild : next;
        }

        function getPrev(active) {
            const prev = active.previousElementSibling;
            return prev === null || !isSlide(prev) ? active.parentNode.lastElementChild : prev;
        }

        function getActiveAndCarousel() {
            const carousel = document.getElementById('carousel');
            const active = carousel.querySelector('.active');
            return {
                carousel: carousel,
                active: active
            }
        }

        function moveRight() {

            const {carousel, active} = getActiveAndCarousel();

            const current = getNext(active);

            const left = active;
            const right = getNext(current);

            const oldLeft = getPrev(left);
            removeActiveState(active);
            hidePreview(oldLeft);

            display(current, left, right);

            carousel.appendChild(oldLeft);
        }

        function moveLeft() {
            const {carousel, active} = getActiveAndCarousel();

            const current = getPrev(active);

            const left = getPrev(current);
            const right = active;

            const oldRight = getNext(right);
            removeActiveState(active);
            hidePreview(oldRight);

            display(current, left, right);

            carousel.insertBefore(left, current);
        }

        function runCarousel() {
            const debug = true;
            const intervalTime = 2000;

            setInterval(function () {

                if (debug) return;

                const active = document.querySelector('.active:hover');
                const isActiveHovered = active !== null;

                if (!isActiveHovered) {
                    moveRight()
                }
            }, intervalTime);
        }

        window.moveRight = moveRight;
        window.moveLeft = moveLeft;
        window.onload = async function () {

            const catsArr = await getCats();
            const cats = new Cats(catsArr);

            const carouselCats = cats.getYoungest(3);
            const carousel = document.getElementById('carousel');

            const slides = carouselCats.map(c => createSlide(c));
            populateCarousel(carousel, slides);
            initSlides(carousel, slides, 0);
            runCarousel();

            const cards = document.getElementById('cards');
            const cardsContainer = new CardsContainer(cards, cats);
            cardsContainer.appendNext(10);

            window.loadCats = function () {
            }
        }
    </script>
</head>
<body>
<div class="row">
    <div id="carousel-container">
        <div id="carousel">
        </div>
        <div class="btn btn-prev" onclick="moveLeft()">
            <span class="arrow">&#10094;</span>
        </div>
        <div class="btn btn-next" onclick="moveRight()">
            <span class="arrow">&#10095;</span>
        </div>
    </div>
</div>
<div class="row">
    <div id="cards-container">
        <div id="cards"></div>
        <div class="button-container">
            <a class="btn btn-load" onclick="loadCats()">Load more</a>
        </div>
    </div>
</div>
</body>
</html>