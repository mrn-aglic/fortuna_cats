<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cats</title>

    <link rel="icon" href="/imgs/favicon.jpg">

    <link rel="stylesheet" href="stylesheets/css/styles.css">
    <link rel="stylesheet" href="stylesheets/css/carousel.css">
    <link rel="stylesheet" href="stylesheets/css/cards.css">
    <link rel="stylesheet" href="stylesheets/css/modal.css">
    <link rel="stylesheet" href="stylesheets/css/menu.css">

    <script type="module" src="/repositories/cats_repository.js"></script>
    <script type="module" src="/classes/DOMFactory.js"></script>
    <script type="module" src="/classes/carousel.js"></script>
    <script type="module" src="/classes/cat.js"></script>
    <script type="module" src="/classes/catcontainer.js"></script>
    <script type="module" src="/classes/modal.js"></script>
    <script type="module" src="/classes/cardscontainer.js"></script>

    <script type="module">

        import {Carousel} from './classes/carousel.js';
        import {Cats} from './classes/catcontainer.js';
        import {CardsContainer} from './classes/cardscontainer.js';
        import getCats from './repositories/cats_repository.js';

        function getOrderBy() {

            const cmpr = {
                '<': (a, b) => isNaN(a) ? a.localeCompare(b) : a - b,
                '>': (a, b) => isNaN(a) ? b.localeCompare(a) : b - a
            };

            const byFeatureV = document.querySelector('input[name="feature"]:checked').value;
            const orderBy = document.querySelector('input[name="order"]:checked').value;

            const byFeature = c => c[byFeatureV];
            const order = cmpr[orderBy];

            return (a, b) => order(byFeature(a), byFeature(b));
        }

        function sort(cats, cardsContainer) {
            const predicate = getFilterFunction();
            const orderBy = getOrderBy();

            cats.sort(orderBy);
            cardsContainer.refreshView(predicate);
        }

        function createPredicateFunctionFromCheckboxes() {
            const paramName = 'c';

            const filters = [...document.querySelectorAll('input[name=filter]')];
            const checked = filters.filter(f => f.checked);
            const values = checked.map(f => f.value.split(/(<[=>]?|===|>=?)/g));

            if (checked.length === 0) {
                return (_ => true);
            }

            const queries = values.map(q => `${paramName}["${q[0]}"] ${q[1]} ${q[2]}`);
            const predicate = queries.join(' &&');
            return new Function(`return function(${paramName}){ return ${predicate}; }`)();
        }

        function getFilterFunction() {
            const searchbox = document.querySelector('#search-menu > input');
            const searchstring = searchbox.value.toLowerCase();

            const searchFilter = c => c.name.toLowerCase().includes(searchstring);

            const f = createPredicateFunctionFromCheckboxes();

            return c => searchFilter(c) && f(c);
        }

        function filter(cardsContainer) {

            const btnLoad = document.querySelector('#btn-load');
            show(btnLoad);

            const predicate = getFilterFunction();
            cardsContainer.refreshView(predicate);
            const moreToLoad = cardsContainer.moreToLoad(predicate);

            if (!moreToLoad) {
                hide(btnLoad);
            }

            updateResultNum(cardsContainer);
        }

        function show(el) {
            el.classList.remove('d-none');
        }

        function hide(el) {
            el.classList.add('d-none');
        }

        function updateResultNum(cardsContainer) {
            const cardsContainerSize = cardsContainer.getSize();
            const result = document.getElementById('result');
            result.innerText = cardsContainerSize;

            const cardsResult = document.getElementById('cards-result');

            if (cardsContainerSize === 0) {
                show(cardsResult);
            } else {
                hide(cardsResult);
            }
        }

        function resetSortMenu() {
            document.getElementById('age-radio').checked = true;
            document.getElementById('order-asc').checked = true;
        }

        window.onload = async function () {

            const useLocalImages = new URLSearchParams(window.location.search).get('local') || false;

            const catsArr = await getCats(useLocalImages);
            const cats = new Cats(catsArr);

            const carouselEl = document.getElementById('carousel');
            const carousel = new Carousel(carouselEl, cats);
            // carousel.run();

            const cards = document.getElementById('cards');
            const cardsContainer = new CardsContainer(cards, cats);
            const loadNum = 20;
            cardsContainer.clickAppend(loadNum);

            updateResultNum(cardsContainer);

            window.loadCats = function () {
                resetSortMenu();
                const moreToLoad = cardsContainer.clickAppend(loadNum, getFilterFunction());

                if (!moreToLoad || cardsContainer.getSize() >= cats.getSize()) {
                    hide(document.querySelector('#btn-load'));
                }

                updateResultNum(cardsContainer);
            }

            window.sort = () => sort(cats, cardsContainer);
            window.filter = () => filter(cardsContainer);
        }
    </script>
</head>
<body>
<div class="row">
    <div id="carousel-container">
        <div id="carousel">
        </div>
        <div class="btn-prev">
            <span class="arrow">&#10094;</span>
        </div>
        <div class="btn-next">
            <span class="arrow">&#10095;</span>
        </div>
    </div>
</div>
<div class="row">
    <div id="display-menu">
        <div id="sort-menu" class="sub-menu">
            <div id="sort-by">
                <span class="menu-label">Sortiraj prema:</span>
                <div class="radio-control">
                    <input name="feature" id="name-radio" value="name" type="radio" onchange="sort()"/>
                    <label for="name-radio">Imenu</label>
                </div>
                <div class="radio-control">
                    <input name="feature" id="age-radio" value="age" type="radio" onchange="sort()" checked/>
                    <label for="age-radio">Dobi</label>
                </div>
            </div>
            <div id="sort-order">
                <span class="menu-label"> Sortiraj: </span>
                <div class="radio-control">
                    <input name="order" id="order-asc" value="<" type="radio" onchange="sort()" checked/>
                    <label for="order-asc">Uzlazno</label>
                </div>
                <div class="radio-control">
                    <input name="order" id="order-desc" value=">" type="radio" onchange="sort()"/>
                    <label for="order-desc">Silazno</label>
                </div>
            </div>
        </div>
        <div id="filter-menu" class="sub-menu">
            <div class="flex-row">
                <span>Rezultata:</span>
                <span id="result"></span>
            </div>
            <div class="filters">
                <span class="menu-item"> Prikaži samo: </span>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="age<=6" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je mlađi od 6 mjeseci</span>
                    </label>
                </div>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="age<=12" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je mlađi od 12 mjeseci</span>
                    </label>
                </div>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="color==='black'" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je crne boje</span>
                    </label>
                </div>
            </div>
        </div>
        <div id="search-menu" class="sub-menu">
            <input type="text" placeholder="Pretraga po imenu" onkeyup="filter()"/>
        </div>
    </div>
</div>
<div class="row">
    <div id="cards-container">
        <div id="cards"></div>
        <div id="cards-result" class="d-none">
            <span>Nije pronađen nijedan rezultat</span>
        </div>
        <div id="btn-load" class="button-container">
            <a class="btn btn-load" onclick="loadCats()">Prikaži više</a>
        </div>
    </div>
</div>
</body>
</html>