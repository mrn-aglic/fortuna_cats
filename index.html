<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cats</title>

    <link rel="icon" href="/imgs/favicon.jpg">

    <link rel="stylesheet" href="stylesheets/css/styles.css">
    <link rel="stylesheet" href="stylesheets/css/carousel.css">
    <link rel="stylesheet" href="stylesheets/css/cards.css">
    <link rel="stylesheet" href="stylesheets/css/menu.css">

    <script type="module" src="/repositories/cats_repository.js"></script>
    <script type="module" src="/classes/cat.js"></script>
    <script type="module" src="/classes/catcontainer.js"></script>
    <script type="module" src="/classes/cardscontainer.js"></script>

    <script type="module">

        import {Cats} from './classes/catcontainer.js';
        import {CardsContainer} from './classes/cardscontainer.js';
        import getCats from './repositories/cats_repository.js';

        function asSlide(slide) {
            slide.classList.remove('slide-preview');
            slide.classList.add('slide');
        }

        function preview(slide) {
            slide.classList.add('slide-preview');
            show(slide);
        }

        function previewBoth(left, right) {
            preview(left);
            preview(right);
            leftPreview(left);
            rightPreview(right);
        }

        function removePreview(slide) {
            slide.classList.remove('slide-preview');
            slide.classList.remove('slide-preview-left');
            slide.classList.remove('slide-preview-right');
        }

        function leftPreview(slide) {
            slide.classList.add('slide-preview-left');
            preview(slide);
        }

        function rightPreview(slide) {
            slide.classList.add('slide-preview-right');
            preview(slide);
        }

        function hide(slide) {
            slide.classList.add('d-none');
        }

        function show(slide) {
            slide.classList.remove('d-none');
        }

        function setActive(slide) {
            slide.classList.add('active');
            removePreview(slide);
            show(slide);
        }

        function removeActiveState(slide) {
            slide.classList.remove('active');
        }

        function isSlide(el) {
            return el.matches('.slide');
        }

        function createImgFromCat(cat) {
            const img = document.createElement('img');
            img.src = cat.url;
            return img;
        }

        function createSlide(cat) {

            const img = createImgFromCat(cat);

            const container = document.createElement('div');
            const textNode = document.createElement('div');

            // const adoptBtn = document.createElement()
            
            textNode.innerText = cat.name;

            asSlide(container);
            hide(container);

            textNode.classList.add('slide-text');

            container.appendChild(img);
            container.appendChild(textNode);

            return container;
        }

        function populateCarousel(carousel, slides) {
            const firstBtn = carousel.querySelector('div.btn');
            const insert = carousel.childNodes.length === 0 ? carousel.appendChild : slide => carousel.insertBefore(slide, firstBtn);
            slides.forEach(insert);
        }

        function getLeftAndRight(idx, slides) {
            return [getPrev(slides[idx]), getNext(slides[idx])];
        }

        function initSlides(carousel, slides, currIdx = 0) {

            const [left, right] = getLeftAndRight(currIdx, slides);
            display(slides[currIdx], left, right);

            carousel.insertBefore(left, slides[currIdx]);
        }

        function display(current, left, right) {
            setActive(current);
            previewBoth(left, right);
        }

        function hidePreview(preview) {
            removePreview(preview);
            hide(preview);
        }

        function getNext(active) {
            const next = active.nextElementSibling;
            return next === null || !isSlide(next) ? active.parentNode.firstElementChild : next;
        }

        function getPrev(active) {
            const prev = active.previousElementSibling;
            return prev === null || !isSlide(prev) ? active.parentNode.lastElementChild : prev;
        }

        function getActiveAndCarousel() {
            const carousel = document.getElementById('carousel');
            const active = carousel.querySelector('.active');
            return {
                carousel: carousel,
                active: active
            }
        }

        function moveRight() {

            const {carousel, active} = getActiveAndCarousel();

            const current = getNext(active);

            const left = active;
            const right = getNext(current);

            const oldLeft = getPrev(left);
            removeActiveState(active);
            hidePreview(oldLeft);

            display(current, left, right);

            carousel.appendChild(oldLeft);
        }

        function moveLeft() {
            const {carousel, active} = getActiveAndCarousel();

            const current = getPrev(active);

            const left = getPrev(current);
            const right = active;

            const oldRight = getNext(right);
            removeActiveState(active);
            hidePreview(oldRight);

            display(current, left, right);

            carousel.insertBefore(left, current);
        }

        function runCarousel() {
            const debug = true;
            const intervalTime = 2000;

            setInterval(function () {

                if (debug) return;

                const active = document.querySelector('.active:hover');
                const isActiveHovered = active !== null;

                if (!isActiveHovered) {
                    moveRight()
                }
            }, intervalTime);
        }

        function getOrderBy() {

            const cmpr = {
                '<': (a, b) => isNaN(a) ? a.localeCompare(b) : a - b,
                '>': (a, b) => isNaN(a) ? b.localeCompare(a) : b - a
            };

            const byV = document.querySelector('input[name="feature"]:checked').value;
            const orderV = document.querySelector('input[name="order"]:checked').value;

            const by = c => c[byV];
            const order = cmpr[orderV];

            return (a, b) => order(by(a), by(b));
        }

        function sort(cardsContainer) {
            const orderBy = getOrderBy();

            cardsContainer.sort(orderBy, getFilterFunction());
        }

        function createPredicateFunctionFromCheckboxes() {
            const paramName = 'c';

            const filters = [...document.querySelectorAll('input[name=filter]')];
            const checked = filters.filter(f => f.checked);
            const values = checked.map(f => f.value.split(/(<[=>]?|===|>=?)/g));

            if (checked.length === 0) {
                return (_ => true);
            }

            const queries = values.map(q => `${paramName}["${q[0]}"] ${q[1]} ${q[2]}`);
            const predicate = queries.join(' &&');
            return new Function(`return function(${paramName}){ return ${predicate}; }`)();
        }

        function getFilterFunction() {
            const searchbox = document.querySelector('#search-menu > input');
            const searchstring = searchbox.value.toLowerCase();

            const searchFilter = c => c.name.toLowerCase().includes(searchstring);

            const f = createPredicateFunctionFromCheckboxes();

            return c => searchFilter(c) && f(c);
        }

        function filter(cardsContainer) {

            showButton();

            const orderBy = getOrderBy();
            const p = getFilterFunction();
            const moreToLoad = cardsContainer.filter(p, orderBy);

            if (!moreToLoad) {
                hideButton();
            }

            updateResultNum(cardsContainer);
        }

        function updateResultNum(cardsContainer) {
            const result = document.getElementById('result');
            result.innerText = cardsContainer.getSize();
        }

        function resetSortMenu() {
            document.getElementById('age-radio').checked = true;
            document.getElementById('order-asc').checked = true;
        }

        function showButton() {
            document.querySelector('.btn-load').style.display = 'inline-block';
        }

        function hideButton() {
            document.querySelector('.btn-load').style.display = 'none';
        }

        // function search(cardsContainer) {
        //     const searchbox = document.querySelector('#search-menu > input');
        //     const searchstring = searchbox.value.toLowerCase();
        //     cardsContainer.filter(c => c.name.toLowerCase().includes(searchstring));
        //
        //     updateResultNum(cardsContainer);
        // }

        window.moveRight = moveRight;
        window.moveLeft = moveLeft;
        window.onload = async function () {

            const useLocalImages = new URLSearchParams(window.location.search).get('local') || false;

            const catsArr = await getCats(useLocalImages);
            const cats = new Cats(catsArr);

            // for debugging
            // window.allcats = catsArr;

            const carouselCats = cats.getYoungest(3);
            const carousel = document.getElementById('carousel');

            const slides = carouselCats.map(c => createSlide(c));
            populateCarousel(carousel, slides);
            initSlides(carousel, slides, 0);
            runCarousel();

            const cards = document.getElementById('cards');
            const cardsContainer = new CardsContainer(cards, cats);
            cardsContainer.clickAppend(20);

            updateResultNum(cardsContainer);

            window.loadCats = function () {
                resetSortMenu();
                const add = 20;
                const [_, moreToLoad] = cardsContainer.clickAppend(add, getOrderBy(), getFilterFunction());
                // window.sort();

                if (!moreToLoad || cardsContainer.getSize() >= cats.getSize()) {
                    hideButton();
                }

                updateResultNum(cardsContainer);
            }

            window.sort = () => sort(cardsContainer);

            window.filter = () => filter(cardsContainer);

            // window.search = () => search(cardsContainer);
        }
    </script>
</head>
<body>
<div class="row">
    <div id="carousel-container">
        <div id="carousel">
        </div>
        <div class="btn-prev" onclick="moveLeft()">
            <span class="arrow">&#10094;</span>
        </div>
        <div class="btn-next" onclick="moveRight()">
            <span class="arrow">&#10095;</span>
        </div>
    </div>
</div>
<div class="row">
    <div id="display-menu">
        <div id="sort-menu" class="sub-menu">
            <div id="sort-by">
                <span class="menu-label">Sortiraj prema:</span>
                <div class="radio-control">
                    <input name="feature" id="name-radio" value="name" type="radio"/>
                    <label for="name-radio">Imenu</label>
                </div>
                <div class="radio-control">
                    <input name="feature" id="age-radio" value="age" type="radio" checked/>
                    <label for="age-radio">Dobi</label>
                </div>
            </div>
            <div id="sort-order">
                <span class="menu-label"> Sortiraj: </span>
                <div class="radio-control">
                    <input name="order" id="order-asc" value="<" type="radio" checked/>
                    <label for="order-asc">Uzlazno</label>
                </div>
                <div class="radio-control">
                    <input name="order" id="order-desc" value=">" type="radio"/>
                    <label for="order-desc">Silazno</label>
                </div>
            </div>
            <div class="button-container">
                <a class="sort-btn" onclick="sort()">Sortiraj</a>
            </div>
        </div>
        <div id="filter-menu" class="sub-menu">
            <div class="flex-row">
                <span>Rezultata:</span>
                <span id="result"></span>
            </div>
            <div class="filters">
                <span class="menu-item"> Prikaži samo: </span>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="age<=6" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je mlađi od 6 mjeseci</span>
                    </label>
                </div>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="age<=12" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je mlađi od 12 mjeseci</span>
                    </label>
                </div>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input name="filter" value="color==='black'" type="checkbox" onchange="filter()"/>
                        <span class="checkbox-box">Mačić je crne boje</span>
                    </label>
                </div>
            </div>
        </div>
        <div id="search-menu" class="sub-menu">
            <input type="text" placeholder="Pretraga po imenu" onkeyup="filter()"/>
        </div>
    </div>
</div>
<div class="row">
    <div id="cards-container">
        <div id="cards"></div>
        <div class="button-container">
            <a class="btn btn-load" onclick="loadCats()">Prikaži više</a>
        </div>
    </div>
</div>
</body>
</html>